; =========================================================
; PIONNEROS V2.0: HW_KERNEL.ASM (Tüm Assembly Kodları)
; =========================================================

; --- A. CONTEXT SWITCH MODÜLÜ (context_switch.asm) ---
global context_switch 

section .text
context_switch:
    ; 1. MEVCUT GÖREVİN KONTEKSİNİ KAYDET
    pushad              
    push ds ; Kayıtları yığına kaydet
    push es             
    push fs             
    push gs             

    ; Mevcut ESP'yi [esp + 52] ofsetindeki current_esp pointer'ına yaz
    mov eax, [esp + 52] 
    mov [eax], esp      

    ; 2. YENİ GÖREVİN KONTEKSİNİ YÜKLE
    ; ESP'yi, [esp + 56] ofsetindeki new_esp'ye ayarla
    mov esp, [esp + 56] 

    pop gs  ; Kayıtları yığından yükle
    pop fs
    pop es
    pop ds
    popad              

    ; 3. GÖREVDEN ÇIKIŞ (Yeni görevi başlatır)
    iret

; --- B. İSTİSNA YAKALAMA ÇEKİRDEĞİ (exceptions.asm) ---

; Dışarıdan C kodu tarafından çağrılacak hata işleyicisi
extern exception_handler

%macro EXCEPTION_HANDLER 1
global exception_handler_%1
exception_handler_%1:
    push %1 
    pusha                       
    call exception_handler      ; C'deki fonksiyonu çağır
    popa
    add esp, 4                  
    iret                        
%endmacro

; Zorunlu İstisnalar
EXCEPTION_HANDLER 0 ; Division by Zero
EXCEPTION_HANDLER 13 ; General Protection Fault (GPF)
EXCEPTION_HANDLER 14 ; Page Fault

; --- C. FARE KESME İŞLEYİCİSİ (mouse.asm) ---

extern mouse_irq_handler
global mouse_irq_handler_asm
mouse_irq_handler_asm:
    push byte 12            
    pusha                   
    call mouse_irq_handler  ; C'deki fonksiyonu çağır
    popa
    
    add esp, 4              
    
    ; PIC'e Kesmeyi Sonlandır (EOI) sinyali
    mov al, 0x20
    out 0xA0, al            
    out 0x20, al            
    iret                        
; =========================================================
; PIONNEROS V2.0: DONANIM VE BAŞLATMA ASSEMBLY
; BÖLÜM 47: ÇEKİRDEK BAŞLATMA VE KESME YÖNLENDİRMELERİ
; =========================================================

; Harici C fonksiyonları için bildiriler
extern kernel_main
extern pit_irq_handler
extern keyboard_irq_handler
extern mouse_irq_handler

; --- ÇEKİRDEK GİRİŞ NOKTASI ---
section .text
global _start
_start:
    ; Yığın (Stack) Alanını Ayarla
    mov esp, 0x90000        ; Yığını RAM'de bir konuma ayarla
    
    ; Segment Yazmaçlarını Başlat
    mov ax, 0x10            ; Data segment selector
    mov ds, ax
    mov es, ax
    mov fs, ax
    mov gs, ax
    mov ss, ax

    ; C Fonksiyonu Çağrısı
    call kernel_main        ; C kodundaki kernel_main fonksiyonunu çağır

    ; Çekirdek sonu (kernel_main'den asla dönmemeliyiz, ama dönersek burada duralım)
.halt:
    cli                     ; Kesmeleri Kapat
    hlt                     ; CPU'yu Durdur
    jmp .halt               ; Sonsuz döngü

; --- TEMEL KESME İŞLEYİCİLERİ ---
; Bu iskeletler, donanım kesmeleri (IRQ) geldiğinde C fonksiyonlarınızı çağırır.

; Zamanlayıcı (PIT) Kesmesi
global irq0_handler
irq0_handler:
    call pit_irq_handler    ; C kodundaki pit_irq_handler'ı çağır
    jmp pic_eoi             ; PIC'e Kesme Sonu (EOI) sinyali gönder

; Klavye Kesmesi
global irq1_handler
irq1_handler:
    call keyboard_irq_handler
    jmp pic_eoi

; Fare Kesmesi (IRQ 12)
global irq12_handler
irq12_handler:
    call mouse_irq_handler
    jmp pic_eoi

; --- PIC KESME SONU (EOI) GÖNDERME İSKELETİ ---
; 8259 PIC yongasına kesmeyi işlediğimizi bildirir.
pic_eoi:
    mov al, 0x20
    out 0x20, al            ; Master PIC'e EOI gönder
    ret
